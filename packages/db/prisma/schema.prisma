// WheelsAI Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Users and Authentication
// ============================================

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String?   @unique
  passwordHash  String?   @map("password_hash")
  walletAddress String?   @unique @map("wallet_address")
  displayName   String?   @map("display_name")
  emailVerified Boolean   @default(false) @map("email_verified")
  metadata      Json?     @default("{}")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  ownedOrganizations Organization[] @relation("OrgOwner")
  memberships        OrgMember[]

  @@map("users")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  ownerId   String   @map("owner_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  owner         User            @relation("OrgOwner", fields: [ownerId], references: [id])
  members       OrgMember[]
  apiKeys       ApiKey[]
  deployments   Deployment[]
  agents        Agent[]
  trainingJobs  TrainingJob[]
  datasets      Dataset[]
  creditBalance CreditBalance?
  transactions  CreditTransaction[]
  usageRecords  UsageRecord[]
  agentWallets  AgentWallet[]
  x402Payments  X402Payment[]

  // Marketplace relations
  publisherProfile   PublisherProfile?
  publishedListings  AgentListing[]     @relation("PublishedAgents")
  agentReviews       AgentReview[]      @relation("AgentReviews")
  agentInstalls      AgentInstall[]     @relation("AgentInstalls")
  agentSubscriptions AgentSubscription[] @relation("AgentSubscriptions")
  creatorPayouts     CreatorPayout[]    @relation("CreatorPayouts")

  @@map("organizations")
}

model OrgMember {
  orgId  String @map("org_id") @db.Uuid
  userId String @map("user_id") @db.Uuid
  role   String // 'owner', 'admin', 'member'

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@map("org_members")
}

// ============================================
// API Keys
// ============================================

model ApiKey {
  id         String    @id @default(uuid()) @db.Uuid
  orgId      String    @map("org_id") @db.Uuid
  keyHash    String    @unique @map("key_hash")
  keyPrefix  String    @map("key_prefix") // First 8 chars for display
  name       String?
  scopes     String[]  @default([])
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

// ============================================
// Model Catalog
// ============================================

model Model {
  id               String   @id // e.g., "llama-3.1-8b"
  hfId             String   @map("hf_id") // HuggingFace model ID
  ollamaModelId    String?  @map("ollama_model_id") // Ollama model name (e.g., "llama3.1:8b")
  displayName      String   @map("display_name")
  description      String?
  parameters       BigInt? // 8B, 70B, etc.
  minGpuTier       String   @map("min_gpu_tier")
  supportedEngines String[] @map("supported_engines")
  defaultEngine    String   @map("default_engine")
  contextLength    Int      @map("context_length")
  license          String?
  tags             String[] @default([])
  pricingTier      String   @map("pricing_tier") // 'small', 'medium', 'large'
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")

  deployments Deployment[]

  @@map("models")
}

// ============================================
// Deployments
// ============================================

model Deployment {
  id           String    @id @default(uuid()) @db.Uuid
  orgId        String    @map("org_id") @db.Uuid
  name         String
  slug         String
  modelId      String    @map("model_id")
  engine       String
  gpuTier      String    @map("gpu_tier")
  replicas     Int       @default(1)
  config       Json
  status       String    // 'pending', 'provisioning', 'running', 'degraded', 'stopped', 'failed'
  nosanaJobIds String[]  @map("nosana_job_ids")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  stoppedAt    DateTime? @map("stopped_at")

  org          Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  model        Model            @relation(fields: [modelId], references: [id])
  nodes        DeploymentNode[]
  usageRecords UsageRecord[]
  agentWallet  AgentWallet?

  @@unique([orgId, slug])
  @@index([orgId])
  @@index([status])
  @@map("deployments")
}

model DeploymentNode {
  id              String    @id @default(uuid()) @db.Uuid
  deploymentId    String    @map("deployment_id") @db.Uuid
  nosanaNodeId    String    @map("nosana_node_id")
  nodeUrl         String    @map("node_url")
  healthStatus    String    @default("unknown") @map("health_status")
  lastHealthCheck DateTime? @map("last_health_check")
  latencyMs       Int?      @map("latency_ms")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  deployment Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([deploymentId])
  @@map("deployment_nodes")
}

// ============================================
// Billing and Credits
// ============================================

model CreditBalance {
  orgId       String   @id @map("org_id") @db.Uuid
  balanceCents BigInt  @default(0) @map("balance_cents")
  updatedAt   DateTime @updatedAt @map("updated_at")

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("credit_balances")
}

model CreditTransaction {
  id           String   @id @default(uuid()) @db.Uuid
  orgId        String   @map("org_id") @db.Uuid
  amountCents  BigInt   @map("amount_cents") // Positive = credit, negative = debit
  type         String   // 'purchase', 'usage', 'refund', 'adjustment', 'bonus'
  description  String?
  referenceId  String?  @map("reference_id") // Stripe charge ID, usage period, etc.
  balanceAfter BigInt   @map("balance_after")
  createdAt    DateTime @default(now()) @map("created_at")

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@map("credit_transactions")
}

// ============================================
// Usage Tracking
// ============================================

model UsageRecord {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  deploymentId  String   @map("deployment_id") @db.Uuid
  periodStart   DateTime @map("period_start")
  periodEnd     DateTime @map("period_end")
  requestCount  Int      @default(0) @map("request_count")
  inputTokens   BigInt   @default(0) @map("input_tokens")
  outputTokens  BigInt   @default(0) @map("output_tokens")
  totalLatencyMs BigInt  @default(0) @map("total_latency_ms")
  errorCount    Int      @default(0) @map("error_count")
  costCents     BigInt   @default(0) @map("cost_cents")

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deployment Deployment   @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@unique([orgId, deploymentId, periodStart])
  @@index([orgId, periodStart])
  @@map("usage_records")
}

// ============================================
// Agent Wallets (Phase 2)
// ============================================

model AgentWallet {
  id              String  @id @default(uuid()) @db.Uuid
  orgId           String  @map("org_id") @db.Uuid
  deploymentId    String  @unique @map("deployment_id") @db.Uuid
  walletAddress   String  @unique @map("wallet_address")
  encryptedKey    Bytes   @map("encrypted_key")
  keyVersion      Int     @default(1) @map("key_version")
  dailyLimitCents BigInt? @map("daily_limit_cents")
  perTxLimitCents BigInt? @map("per_tx_limit_cents")
  allowedDomains  String[] @default([]) @map("allowed_domains")
  isActive        Boolean @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  org          Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deployment   Deployment         @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  transactions AgentTransaction[]

  @@map("agent_wallets")
}

model AgentTransaction {
  id            String   @id @default(uuid()) @db.Uuid
  walletId      String   @map("wallet_id") @db.Uuid
  direction     String   // 'in', 'out'
  amountLamports BigInt  @map("amount_lamports")
  token         String   // 'SOL', 'USDC', 'NOS'
  counterparty  String
  txSignature   String?  @unique @map("tx_signature")
  status        String   @default("pending")
  createdAt     DateTime @default(now()) @map("created_at")

  wallet AgentWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("agent_transactions")
}

// ============================================
// Agents (Phase 2)
// ============================================

model Agent {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  name          String
  slug          String
  description   String?
  framework     String   // 'mastra', 'langchain', 'autogen', 'custom'

  // Agent configuration
  systemPrompt  String?  @map("system_prompt") @db.Text
  tools         Json     @default("[]") // Array of tool configurations
  modelConfig   Json     @map("model_config") // Model to use, temperature, etc.

  // Source code / definition
  sourceType    String   @map("source_type") // 'inline', 'github', 'ipfs'
  sourceUrl     String?  @map("source_url") // GitHub repo URL or IPFS hash
  sourceCode    String?  @map("source_code") @db.Text // Inline code if sourceType = 'inline'

  // Runtime configuration
  env           Json     @default("{}") // Environment variables (encrypted sensitive values)
  secrets       Bytes?   // Encrypted secrets blob

  // Metadata
  version       String   @default("1.0.0")
  isPublic      Boolean  @default(false) @map("is_public")
  tags          String[] @default([])

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  org           Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  deployments   AgentDeployment[]
  listing       AgentListing?
  graph         AgentGraph?

  @@unique([orgId, slug])
  @@index([orgId])
  @@map("agents")
}

model AgentDeployment {
  id            String   @id @default(uuid()) @db.Uuid
  agentId       String   @map("agent_id") @db.Uuid

  // Deployment configuration
  gpuTier       String   @map("gpu_tier")
  replicas      Int      @default(1)

  // Model deployment reference (if using dedicated model)
  modelDeploymentId String? @map("model_deployment_id") @db.Uuid

  // External model endpoint (if using external API)
  externalModelUrl  String? @map("external_model_url")
  externalModelKey  Bytes?  @map("external_model_key") // Encrypted

  // Status
  status        String   @default("pending") // 'pending', 'building', 'deploying', 'running', 'stopped', 'failed'
  endpoint      String?  // Public endpoint URL
  nosanaJobIds  String[] @map("nosana_job_ids")

  // Wallet for autonomous payments
  walletId      String?  @unique @map("wallet_id") @db.Uuid

  // Logs and metrics
  buildLogs     String?  @map("build_logs") @db.Text
  lastError     String?  @map("last_error")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  stoppedAt     DateTime? @map("stopped_at")

  agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@map("agent_deployments")
}

// ============================================
// Training Studio (Phase 2)
// ============================================

model Dataset {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  name          String
  description   String?

  // Storage
  storageType   String   @map("storage_type") // 's3', 'ipfs', 'huggingface'
  storageUrl    String   @map("storage_url")

  // Metadata
  format        String   // 'jsonl', 'csv', 'parquet', 'alpaca', 'sharegpt'
  sizeBytes     BigInt   @map("size_bytes")
  rowCount      Int      @map("row_count")

  // Validation
  isValidated   Boolean  @default(false) @map("is_validated")
  validationErrors Json? @map("validation_errors")

  // Sample data for preview
  sampleRows    Json?    @map("sample_rows")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  org           Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  trainingJobs  TrainingJob[]

  @@unique([orgId, name])
  @@index([orgId])
  @@map("datasets")
}

model TrainingJob {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  name          String

  // Base model
  baseModelId   String   @map("base_model_id")
  baseModelHfId String   @map("base_model_hf_id")

  // Dataset
  datasetId     String   @map("dataset_id") @db.Uuid

  // Training method
  method        String   // 'lora', 'qlora', 'full' (full only for small models)

  // Hyperparameters
  config        Json     // epochs, learning_rate, batch_size, lora_r, lora_alpha, etc.

  // GPU requirements
  gpuTier       String   @map("gpu_tier")
  gpuCount      Int      @default(1) @map("gpu_count")

  // Status
  status        String   @default("pending") // 'pending', 'queued', 'running', 'completed', 'failed', 'cancelled'
  progress      Int      @default(0) // 0-100
  currentEpoch  Int?     @map("current_epoch")
  totalEpochs   Int?     @map("total_epochs")

  // Nosana integration
  nosanaJobId   String?  @map("nosana_job_id")

  // Output
  outputModelId String?  @map("output_model_id") // Reference to created Model entry
  outputPath    String?  @map("output_path") // S3/IPFS path to adapter weights

  // Metrics
  trainingLoss  Float?   @map("training_loss")
  evalLoss      Float?   @map("eval_loss")
  metrics       Json?    // Full training metrics history

  // Logs
  logs          String?  @db.Text
  lastError     String?  @map("last_error")

  // Cost tracking
  estimatedCostCents BigInt? @map("estimated_cost_cents")
  actualCostCents    BigInt? @map("actual_cost_cents")

  // Timestamps
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  dataset       Dataset      @relation(fields: [datasetId], references: [id])

  @@index([orgId])
  @@index([status])
  @@map("training_jobs")
}

// ============================================
// X-402 Payments (Phase 2)
// ============================================

model X402Payment {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid

  // Request context
  deploymentId  String?  @map("deployment_id") @db.Uuid
  agentDeploymentId String? @map("agent_deployment_id") @db.Uuid
  requestId     String   @map("request_id") // Correlation ID

  // Payment details
  network       String   // 'solana:mainnet', 'solana:devnet'
  asset         String   // 'USDC', 'SOL', 'NOS'
  amountRaw     String   @map("amount_raw") // Raw amount as string (to handle big numbers)
  amountUsd     Float    @map("amount_usd") // USD equivalent at time of payment

  // Transaction
  payerAddress  String   @map("payer_address")
  payeeAddress  String   @map("payee_address")
  txSignature   String?  @unique @map("tx_signature")

  // Status
  status        String   @default("pending") // 'pending', 'verified', 'settled', 'failed', 'refunded'
  verifiedAt    DateTime? @map("verified_at")
  settledAt     DateTime? @map("settled_at")

  // Error handling
  failureReason String?  @map("failure_reason")
  retryCount    Int      @default(0) @map("retry_count")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([txSignature])
  @@index([status])
  @@map("x402_payments")
}

// ============================================
// Agent Marketplace (Phase 3)
// ============================================

model AgentListing {
  id                String    @id @default(uuid()) @db.Uuid
  agentId           String    @unique @map("agent_id") @db.Uuid
  title             String
  slug              String    @unique // URL-friendly identifier
  shortDescription  String    @map("short_description") @db.VarChar(280)
  longDescription   String?   @map("long_description") @db.Text
  category          String    // 'customer-support', 'coding', 'research', 'automation', 'creative', 'other'
  iconUrl           String?   @map("icon_url")
  screenshots       String[]  @default([])
  readme            String?   @db.Text

  // Pricing
  pricingModel      String    @map("pricing_model") // 'free', 'per_request', 'monthly'
  pricePerRequestCents BigInt? @map("price_per_request_cents")
  monthlyPriceCents BigInt?   @map("monthly_price_cents")

  // Publisher
  publisherId       String    @map("publisher_id") @db.Uuid
  publisherName     String    @map("publisher_name")

  // Status & Stats
  status            String    @default("draft") // 'draft', 'pending_review', 'published', 'archived'
  isFeatured        Boolean   @default(false) @map("is_featured")
  totalInstalls     Int       @default(0) @map("total_installs")
  activeInstalls    Int       @default(0) @map("active_installs")
  avgRating         Float     @default(0) @map("avg_rating")
  reviewCount       Int       @default(0) @map("review_count")
  totalRequests     BigInt    @default(0) @map("total_requests")

  publishedAt       DateTime? @map("published_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  agent             Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  publisher         Organization @relation("PublishedAgents", fields: [publisherId], references: [id])
  reviews           AgentReview[]
  installs          AgentInstall[]
  subscriptions     AgentSubscription[]

  @@index([publisherId])
  @@index([status, category])
  @@index([avgRating])
  @@index([isFeatured, status])
  @@map("agent_listings")
}

model AgentReview {
  id            String   @id @default(uuid()) @db.Uuid
  listingId     String   @map("listing_id") @db.Uuid
  reviewerId    String   @map("reviewer_id") @db.Uuid
  rating        Int      // 1-5
  title         String?  @db.VarChar(200)
  content       String?  @db.Text
  isVerified    Boolean  @default(false) @map("is_verified") // Verified if reviewer has installed agent
  helpfulCount  Int      @default(0) @map("helpful_count")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  listing       AgentListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  reviewer      Organization @relation("AgentReviews", fields: [reviewerId], references: [id])

  @@unique([listingId, reviewerId])
  @@index([listingId, createdAt])
  @@map("agent_reviews")
}

model AgentInstall {
  id              String    @id @default(uuid()) @db.Uuid
  listingId       String    @map("listing_id") @db.Uuid
  buyerId         String    @map("buyer_id") @db.Uuid
  clonedAgentId   String?   @map("cloned_agent_id") @db.Uuid // The cloned agent in buyer's account
  status          String    @default("active") // 'active', 'stopped', 'uninstalled'
  totalRequests   BigInt    @default(0) @map("total_requests")
  totalSpentCents BigInt    @default(0) @map("total_spent_cents")
  installedAt     DateTime  @default(now()) @map("installed_at")
  uninstalledAt   DateTime? @map("uninstalled_at")

  listing         AgentListing @relation(fields: [listingId], references: [id])
  buyer           Organization @relation("AgentInstalls", fields: [buyerId], references: [id])

  @@unique([listingId, buyerId])
  @@index([buyerId])
  @@map("agent_installs")
}

model AgentSubscription {
  id                  String    @id @default(uuid()) @db.Uuid
  listingId           String    @map("listing_id") @db.Uuid
  subscriberId        String    @map("subscriber_id") @db.Uuid
  status              String    @default("active") // 'active', 'cancelled', 'expired', 'past_due'
  currentPeriodStart  DateTime  @map("current_period_start")
  currentPeriodEnd    DateTime  @map("current_period_end")
  cancelAtPeriodEnd   Boolean   @default(false) @map("cancel_at_period_end")
  cancelledAt         DateTime? @map("cancelled_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  listing             AgentListing @relation(fields: [listingId], references: [id])
  subscriber          Organization @relation("AgentSubscriptions", fields: [subscriberId], references: [id])

  @@unique([listingId, subscriberId])
  @@index([subscriberId])
  @@index([currentPeriodEnd, status])
  @@map("agent_subscriptions")
}

model PublisherProfile {
  orgId              String   @id @map("org_id") @db.Uuid
  displayName        String   @map("display_name")
  slug               String   @unique // URL-friendly identifier
  bio                String?  @db.Text
  avatarUrl          String?  @map("avatar_url")
  website            String?
  twitter            String?
  github             String?
  isVerified         Boolean  @default(false) @map("is_verified")
  totalRevenueCents  BigInt   @default(0) @map("total_revenue_cents")
  pendingPayoutCents BigInt   @default(0) @map("pending_payout_cents")
  totalListings      Int      @default(0) @map("total_listings")
  totalInstalls      Int      @default(0) @map("total_installs")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Reputation System fields
  reputationScore    Float    @default(0) @map("reputation_score") // 0-100 score
  reputationTier     String   @default("new") @map("reputation_tier") // 'new', 'bronze', 'silver', 'gold', 'platinum'
  avgResponseTimeMs  BigInt?  @map("avg_response_time_ms") // Average response time
  supportResponseMs  BigInt?  @map("support_response_ms") // Average support response time
  successfulPayouts  Int      @default(0) @map("successful_payouts")
  disputeCount       Int      @default(0) @map("dispute_count")
  disputeResolvedCount Int    @default(0) @map("dispute_resolved_count")
  joinedDaysAgo      Int      @default(0) @map("joined_days_ago") // Calculated on profile update
  badges             String[] @default([]) // 'fast-responder', 'top-rated', 'verified-developer', etc.
  lastReputationCalc DateTime? @map("last_reputation_calc")

  org                Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("publisher_profiles")
}

model CreatorPayout {
  id                String    @id @default(uuid()) @db.Uuid
  publisherId       String    @map("publisher_id") @db.Uuid
  amountCents       BigInt    @map("amount_cents")
  payoutMethod      String    @map("payout_method") // 'credits', 'crypto_usdc', 'crypto_sol'
  payoutAddress     String?   @map("payout_address") // Wallet address for crypto payouts
  status            String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  txSignature       String?   @unique @map("tx_signature")

  // Revenue breakdown
  grossRevenueCents BigInt    @map("gross_revenue_cents")
  platformFeeCents  BigInt    @map("platform_fee_cents") // 10% platform fee

  // Period covered
  periodStart       DateTime  @map("period_start")
  periodEnd         DateTime  @map("period_end")

  requestedAt       DateTime  @default(now()) @map("requested_at")
  processedAt       DateTime? @map("processed_at")
  failureReason     String?   @map("failure_reason")

  publisher         Organization @relation("CreatorPayouts", fields: [publisherId], references: [id])

  @@index([publisherId, status])
  @@map("creator_payouts")
}

// Revenue tracking for marketplace transactions
model MarketplaceRevenue {
  id              String   @id @default(uuid()) @db.Uuid
  listingId       String   @map("listing_id") @db.Uuid
  installId       String?  @map("install_id") @db.Uuid
  subscriptionId  String?  @map("subscription_id") @db.Uuid
  buyerId         String   @map("buyer_id") @db.Uuid
  publisherId     String   @map("publisher_id") @db.Uuid

  // Transaction type
  type            String   // 'per_request', 'subscription', 'subscription_renewal'

  // Amounts
  grossAmountCents BigInt  @map("gross_amount_cents")
  platformFeeCents BigInt  @map("platform_fee_cents") // 10%
  creatorAmountCents BigInt @map("creator_amount_cents") // 90%

  // Request count (for per_request billing)
  requestCount    Int      @default(1) @map("request_count")

  // Status
  status          String   @default("pending") // 'pending', 'settled', 'refunded'
  settledAt       DateTime? @map("settled_at")

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([listingId, createdAt])
  @@index([publisherId, createdAt])
  @@index([buyerId, createdAt])
  @@index([status])
  @@map("marketplace_revenue")
}

// ============================================
// Enterprise Features (Phase 3)
// ============================================

model AuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  userId        String?  @map("user_id") @db.Uuid
  action        String   // 'create', 'update', 'delete', 'login', 'logout', 'deploy', 'invite', etc.
  resource      String   // 'deployment', 'agent', 'api_key', 'user', 'settings', etc.
  resourceId    String?  @map("resource_id")
  details       Json?    // Additional context
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  status        String   @default("success") // 'success', 'failure'
  errorMessage  String?  @map("error_message")
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([orgId, createdAt])
  @@index([orgId, action])
  @@index([orgId, resource])
  @@index([userId])
  @@map("audit_logs")
}

model SsoConfig {
  orgId           String   @id @map("org_id") @db.Uuid
  provider        String   // 'saml', 'oidc'
  enabled         Boolean  @default(false)

  // SAML settings
  samlEntityId    String?  @map("saml_entity_id")
  samlSsoUrl      String?  @map("saml_sso_url")
  samlCertificate String?  @map("saml_certificate") @db.Text

  // OIDC settings
  oidcClientId    String?  @map("oidc_client_id")
  oidcClientSecret Bytes?  @map("oidc_client_secret") // Encrypted
  oidcIssuer      String?  @map("oidc_issuer")
  oidcScopes      String[] @default(["openid", "profile", "email"]) @map("oidc_scopes")

  // Domain settings
  allowedDomains  String[] @default([]) @map("allowed_domains")
  autoProvision   Boolean  @default(true) @map("auto_provision")
  defaultRole     String   @default("member") @map("default_role")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("sso_configs")
}

model TeamInvite {
  id            String    @id @default(uuid()) @db.Uuid
  orgId         String    @map("org_id") @db.Uuid
  email         String
  role          String    @default("member")
  invitedBy     String    @map("invited_by") @db.Uuid
  token         String    @unique
  status        String    @default("pending") // 'pending', 'accepted', 'expired', 'revoked'
  expiresAt     DateTime  @map("expires_at")
  acceptedAt    DateTime? @map("accepted_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([orgId, status])
  @@index([email])
  @@map("team_invites")
}

// ============================================
// Visual Agent Builder (Phase 3)
// ============================================

model AgentGraph {
  id            String   @id @default(uuid()) @db.Uuid
  agentId       String   @unique @map("agent_id") @db.Uuid

  // Graph structure
  nodes         Json     @default("[]") // Array of node definitions
  edges         Json     @default("[]") // Array of edge connections
  viewport      Json?    // Saved viewport position/zoom

  // Metadata
  version       Int      @default(1)
  isValid       Boolean  @default(false) @map("is_valid")
  validationErrors Json? @map("validation_errors")

  // Generated code cache
  generatedCode String?  @map("generated_code") @db.Text
  codeLanguage  String?  @map("code_language") // 'typescript', 'python'
  lastGenerated DateTime? @map("last_generated")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  agent         Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("agent_graphs")
}

// ============================================
// Advanced Analytics (Phase 3)
// ============================================

model AnalyticsSnapshot {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  snapshotType    String   @map("snapshot_type") // 'daily', 'weekly', 'monthly'
  periodStart     DateTime @map("period_start")
  periodEnd       DateTime @map("period_end")

  // Usage metrics
  totalRequests   BigInt   @default(0) @map("total_requests")
  totalTokensIn   BigInt   @default(0) @map("total_tokens_in")
  totalTokensOut  BigInt   @default(0) @map("total_tokens_out")
  totalCostCents  BigInt   @default(0) @map("total_cost_cents")

  // Performance metrics
  avgLatencyMs    Float?   @map("avg_latency_ms")
  p50LatencyMs    Float?   @map("p50_latency_ms")
  p95LatencyMs    Float?   @map("p95_latency_ms")
  p99LatencyMs    Float?   @map("p99_latency_ms")
  errorRate       Float?   @map("error_rate")

  // Deployment breakdown
  deploymentStats Json?    @map("deployment_stats") // { [deploymentId]: { requests, tokens, cost } }
  agentStats      Json?    @map("agent_stats") // { [agentId]: { requests, tokens, cost } }
  modelStats      Json?    @map("model_stats") // { [modelId]: { requests, tokens, cost } }

  // Cost breakdown
  costByGpuTier   Json?    @map("cost_by_gpu_tier")
  costByModel     Json?    @map("cost_by_model")

  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([orgId, snapshotType, periodStart])
  @@index([orgId, snapshotType, periodStart])
  @@map("analytics_snapshots")
}

// ============================================
// Monitoring & Alerting (Phase 4)
// ============================================

model AlertChannel {
  id            String   @id @default(uuid()) @db.Uuid
  orgId         String   @map("org_id") @db.Uuid
  name          String
  type          String   // 'slack', 'discord', 'email', 'webhook', 'pagerduty'

  // Channel configuration (encrypted for webhooks)
  config        Json     // { webhookUrl, email, slackChannel, etc. }

  isEnabled     Boolean  @default(true) @map("is_enabled")
  lastTestedAt  DateTime? @map("last_tested_at")
  lastError     String?  @map("last_error")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  alertRules    AlertRuleChannel[]

  @@unique([orgId, name])
  @@index([orgId])
  @@map("alert_channels")
}

model AlertRule {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  name            String
  description     String?

  // Rule type and target
  ruleType        String   @map("rule_type") // 'threshold', 'anomaly', 'uptime', 'budget'
  resourceType    String   @map("resource_type") // 'deployment', 'agent', 'organization'
  resourceId      String?  @map("resource_id") @db.Uuid // null = all resources

  // Condition
  metric          String   // 'error_rate', 'latency_p95', 'request_count', 'cost', 'uptime'
  operator        String   // 'gt', 'gte', 'lt', 'lte', 'eq'
  threshold       Float    // Threshold value
  windowMinutes   Int      @default(5) @map("window_minutes") // Evaluation window

  // Alert settings
  severity        String   @default("warning") // 'info', 'warning', 'critical'
  cooldownMinutes Int      @default(60) @map("cooldown_minutes") // Min time between alerts

  isEnabled       Boolean  @default(true) @map("is_enabled")
  lastTriggeredAt DateTime? @map("last_triggered_at")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  channels        AlertRuleChannel[]
  alerts          Alert[]

  @@unique([orgId, name])
  @@index([orgId, isEnabled])
  @@index([resourceType, resourceId])
  @@map("alert_rules")
}

model AlertRuleChannel {
  ruleId    String @map("rule_id") @db.Uuid
  channelId String @map("channel_id") @db.Uuid

  rule      AlertRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  channel   AlertChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@id([ruleId, channelId])
  @@map("alert_rule_channels")
}

model Alert {
  id              String    @id @default(uuid()) @db.Uuid
  orgId           String    @map("org_id") @db.Uuid
  ruleId          String    @map("rule_id") @db.Uuid

  // Alert details
  status          String    @default("active") // 'active', 'acknowledged', 'resolved'
  severity        String    // 'info', 'warning', 'critical'
  title           String
  message         String    @db.Text

  // Context
  resourceType    String    @map("resource_type")
  resourceId      String?   @map("resource_id") @db.Uuid
  metricValue     Float     @map("metric_value") // The value that triggered the alert
  threshold       Float     // The threshold that was breached

  // Timeline
  triggeredAt     DateTime  @default(now()) @map("triggered_at")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  acknowledgedBy  String?   @map("acknowledged_by") @db.Uuid
  resolvedAt      DateTime? @map("resolved_at")
  resolvedBy      String?   @map("resolved_by") @db.Uuid

  // Notification tracking
  notificationsSent Json?   @map("notifications_sent") // { [channelId]: { sentAt, success, error } }

  rule            AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@index([orgId, triggeredAt])
  @@index([ruleId, status])
  @@map("alerts")
}

model UptimeMonitor {
  id              String   @id @default(uuid()) @db.Uuid
  orgId           String   @map("org_id") @db.Uuid
  name            String

  // Target configuration
  targetType      String   @map("target_type") // 'deployment', 'agent', 'custom_url'
  targetId        String?  @map("target_id") @db.Uuid
  targetUrl       String?  @map("target_url") // For custom URLs

  // Check configuration
  checkIntervalSeconds Int @default(60) @map("check_interval_seconds")
  timeoutSeconds  Int      @default(30) @map("timeout_seconds")
  httpMethod      String   @default("GET") @map("http_method")
  expectedStatus  Int      @default(200) @map("expected_status")
  expectedBody    String?  @map("expected_body") // Optional substring to check
  headers         Json?    // Custom headers for the check

  // Status
  isEnabled       Boolean  @default(true) @map("is_enabled")
  currentStatus   String   @default("unknown") @map("current_status") // 'up', 'down', 'degraded', 'unknown'
  lastCheckAt     DateTime? @map("last_check_at")
  lastUpAt        DateTime? @map("last_up_at")
  lastDownAt      DateTime? @map("last_down_at")

  // Stats
  uptimePercent24h Float?  @map("uptime_percent_24h")
  uptimePercent7d  Float?  @map("uptime_percent_7d")
  uptimePercent30d Float?  @map("uptime_percent_30d")
  avgLatencyMs    Float?   @map("avg_latency_ms")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  events          UptimeEvent[]

  @@unique([orgId, name])
  @@index([orgId, isEnabled])
  @@map("uptime_monitors")
}

model UptimeEvent {
  id              String   @id @default(uuid()) @db.Uuid
  monitorId       String   @map("monitor_id") @db.Uuid

  // Check result
  status          String   // 'up', 'down', 'degraded', 'timeout', 'error'
  statusCode      Int?     @map("status_code")
  latencyMs       Int?     @map("latency_ms")
  errorMessage    String?  @map("error_message")

  // Response details
  responseBody    String?  @map("response_body") @db.Text // Stored only on errors
  responseHeaders Json?    @map("response_headers")

  // Location (for distributed checks)
  checkRegion     String?  @map("check_region") // 'us-east', 'eu-west', etc.

  checkedAt       DateTime @default(now()) @map("checked_at")

  monitor         UptimeMonitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId, checkedAt])
  @@index([monitorId, status])
  @@map("uptime_events")
}

// ============================================
// Agent Versioning (Phase 4)
// ============================================

model AgentVersion {
  id            String   @id @default(uuid()) @db.Uuid
  agentId       String   @map("agent_id") @db.Uuid
  version       String   // Semantic version: "1.0.0", "1.1.0", etc.
  versionNumber Int      @map("version_number") // Auto-incrementing version number

  // Snapshot of agent configuration at this version
  name          String
  description   String?
  framework     String
  systemPrompt  String?  @map("system_prompt") @db.Text
  tools         Json     @default("[]")
  modelConfig   Json     @map("model_config")
  sourceType    String   @map("source_type")
  sourceUrl     String?  @map("source_url")
  sourceCode    String?  @map("source_code") @db.Text
  env           Json     @default("{}")

  // Graph snapshot (if visual builder was used)
  graphNodes    Json?    @map("graph_nodes")
  graphEdges    Json?    @map("graph_edges")

  // Version metadata
  changeLog     String?  @map("change_log") @db.Text // Description of changes
  changeType    String   @map("change_type") // 'major', 'minor', 'patch'
  tags          String[] @default([])

  // Author
  createdById   String   @map("created_by_id") @db.Uuid
  createdByName String?  @map("created_by_name")

  // Status
  isLatest      Boolean  @default(false) @map("is_latest")
  isPublished   Boolean  @default(false) @map("is_published") // Published to marketplace
  publishedAt   DateTime? @map("published_at")

  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([agentId, version])
  @@unique([agentId, versionNumber])
  @@index([agentId, isLatest])
  @@index([agentId, createdAt])
  @@map("agent_versions")
}

model AgentVersionDiff {
  id              String   @id @default(uuid()) @db.Uuid
  agentId         String   @map("agent_id") @db.Uuid
  fromVersion     String   @map("from_version")
  toVersion       String   @map("to_version")

  // Diff details
  changes         Json     // { field: { from: ..., to: ... }, ... }
  addedFields     String[] @default([]) @map("added_fields")
  removedFields   String[] @default([]) @map("removed_fields")
  modifiedFields  String[] @default([]) @map("modified_fields")

  // Stats
  linesAdded      Int      @default(0) @map("lines_added")
  linesRemoved    Int      @default(0) @map("lines_removed")

  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([agentId, fromVersion, toVersion])
  @@map("agent_version_diffs")
}
